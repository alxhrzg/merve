# GitHub Actions Workflow Versioning System

## Overview

To prevent silent failures when MLServer's build process evolves, we've implemented a **workflow versioning system** that validates compatibility between your GitHub Actions workflow and the MLServer version you're using.

## How It Works

### 1. Version Markers in Generated Workflows

When you run `mlserver init-github`, the generated workflow file includes version markers:

```yaml
# Generated by MLServer 0.3.2.dev9
# Workflow version: 1.0
# Do not edit manually - regenerate with: mlserver init-github --force
name: Build & Publish ML Classifier Container
...
```

- **MLServer version**: The version of MLServer that generated this workflow
- **Workflow version**: Semantic version of the workflow structure (incremented on incompatible changes)

### 2. Compatibility Validation

During `mlserver tag` and deployment operations, the system validates:

1. **Workflow exists**: Checks if `.github/workflows/ml-classifier-container-build.yml` is present
2. **Version markers present**: Detects old/manually-created workflows
3. **Workflow version matches**: Ensures workflow is compatible with current MLServer

### 3. Validation Modes

#### Lenient Mode (Tag Validation)
- **Used by**: `mlserver tag`
- **Behavior**: Warns but allows tagging to proceed
- **Example**:
  ```
  ⚠ Workflow file is missing version markers (generated by old MLServer or
  manually created). Consider regenerating with: mlserver init-github --force
  ✓ Created tag: classifier-v1.0.0-mlserver-abc123d
  ```

#### Strict Mode (Deploy Validation)
- **Used by**: Future deployment commands
- **Behavior**: Fails if workflow is incompatible
- **Example**:
  ```
  ✗ Validation failed: GitHub Actions workflow is incompatible
    File has workflow v1.0, but current MLServer expects v2.0
    Solution: Regenerate with mlserver init-github --force
  ```

## When Workflow Version Changes

The **workflow version** increments when there are **breaking changes** to the workflow structure:

### Examples of Breaking Changes:
- Change in required environment variables
- New mandatory build steps
- Different Docker build process
- Updated API for version verification
- Changes to container tagging strategy

### Examples of Non-Breaking Changes:
- Bug fixes in existing steps
- Performance improvements
- Better error messages
- Additional optional features

## Managing Workflow Updates

### Check Your Workflow Compatibility

```bash
# View current workflow version
head -n 5 .github/workflows/ml-classifier-container-build.yml

# Test validation
python -c "
from mlserver.github_actions import validate_workflow_compatibility
is_valid, warning, details = validate_workflow_compatibility('.')
print(f'Valid: {is_valid}')
if warning: print(f'Warning: {warning}')
print(f'Details: {details}')
"
```

### Regenerate Workflow

If you see warnings or your workflow fails:

```bash
# Regenerate workflow (overwrites existing)
mlserver init-github --force

# Review changes
git diff .github/workflows/ml-classifier-container-build.yml

# Commit and push
git add .github/workflows/
git commit -m "Update GitHub Actions workflow to v2.0"
git push
```

## Benefits

### 1. **Prevents Silent Failures**
Old workflows won't silently fail when MLServer's build process changes.

### 2. **Clear Migration Path**
When workflows need updating, you get clear instructions on how to fix them.

### 3. **Version Control Integration**
Workflow version is tracked in git, making it easy to see when updates are needed.

### 4. **Flexible Enforcement**
- Development: Warnings only (lenient)
- Production: Hard failures (strict)

## For Custom Workflows

If you've customized your workflow:

1. **Keep version markers**: Add them to the top of your custom workflow
   ```yaml
   # Generated by MLServer 0.3.2.dev9
   # Workflow version: 1.0
   # Custom modifications: Added deployment notifications
   ```

2. **Update workflow version**: When you modify critical steps, update the version marker

3. **Document changes**: Use git commit messages to track customizations

## Architecture Details

### Components

1. **`generate_build_and_push_workflow()`** (github_actions.py)
   - Embeds version markers in generated workflows
   - Gets current MLServer and workflow versions

2. **`parse_workflow_version()`** (github_actions.py)
   - Extracts version markers from existing workflow files
   - Returns `(mlserver_version, workflow_version)` tuple

3. **`validate_workflow_compatibility()`** (github_actions.py)
   - Compares file versions with current versions
   - Returns `(is_valid, warning_message, details)`
   - Supports strict and lenient modes

4. **`GitHubActionsConfiguredValidator`** (validation.py)
   - Validator that runs during pre-tag checks
   - Configurable: `check_compatibility`, `strict`
   - Integrated into validation suites

### Validation Suites

```python
# Tag validation (lenient)
get_tag_validation_suite()
  ├─ GitRepositoryExistsValidator()
  ├─ ProjectInitializedValidator()
  ├─ ConfigurationValidValidator()
  ├─ GitWorkingDirectoryCleanValidator()
  └─ GitHubActionsConfiguredValidator(check_compatibility=True, strict=False)

# Deploy validation (strict)
get_deploy_validation_suite()
  ├─ GitRepositoryExistsValidator()
  ├─ ProjectInitializedValidator()
  ├─ ConfigurationValidValidator()
  ├─ GitWorkingDirectoryCleanValidator()
  └─ GitHubActionsConfiguredValidator(check_compatibility=True, strict=True)
```

## Future Enhancements

Potential improvements:

1. **Semantic versioning for workflows**: Major.minor.patch versions
2. **Auto-migration scripts**: Automatic workflow updates for minor changes
3. **Workflow changelog**: Document what changed between versions
4. **Compatibility matrix**: Which workflow versions work with which MLServer versions
5. **CI validation**: GitHub Action to validate workflow compatibility in PRs

## Example Scenario

### Scenario: MLServer v0.4 Changes Build Process

1. **MLServer v0.4 released** with new container build process
2. **Workflow version bumped** from `1.0` to `2.0`
3. **User runs** `mlserver tag patch`
4. **Validation detects** workflow v1.0 but expects v2.0
5. **User sees warning**:
   ```
   ⚠ Workflow version mismatch! File has v1.0, but current MLServer expects v2.0
   Regenerate with: mlserver init-github --force
   ```
6. **User regenerates** workflow: `mlserver init-github --force`
7. **Workflow updated** to v2.0 with new build process
8. **Next tag succeeds** with compatible workflow

## Summary

The workflow versioning system provides:
- ✅ **Safety**: Detects incompatible workflows before they fail in CI
- ✅ **Clarity**: Clear warnings and solutions for outdated workflows
- ✅ **Flexibility**: Lenient for development, strict for production
- ✅ **Maintainability**: Easy to update workflows when MLServer evolves
- ✅ **Traceability**: Version markers tracked in git history

This ensures your CI/CD pipeline stays in sync with MLServer's evolving build process.
